<!DOCTYPE html>
<html lang="zh-Hant" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>食物熱量計算器 (修正重複宣告錯誤)</title> <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/jf-openhuninn-1.1/font.min.css' />
    <style>
        /* 基本樣式與字體設定 */
        body {
            font-family: 'jf-openhuninn', 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .dark body {
            background-color: #1f2937;
            color: #d1d5db;
        }
        /* 滾動條 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .dark ::-webkit-scrollbar-track { background: #374151; }
        .dark ::-webkit-scrollbar-thumb { background: #6b7280; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        /* 訊息框 */
        .message-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out;
            max-width: 90%; text-align: center; border: 1px solid transparent;
        }
        .message-box.success { background-color: #dcfce7; color: #166534; border-color: #a7f3d0; }
        .message-box.error { background-color: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .message-box.info { background-color: #e0f2fe; color: #075985; border-color: #bae6fd; }
        .dark .message-box.success { background-color: #14532d; color: #a7f3d0; border-color: #059669; }
        .dark .message-box.error { background-color: #7f1d1d; color: #fecaca; border-color: #dc2626; }
        .dark .message-box.info { background-color: #1e3a8a; color: #bae6fd; border-color: #3b82f6; }
        .message-box.show { opacity: 1; }

        /* 搜尋結果 & 最近新增列表 & 管理搜尋列表 */
        #searchResults li, #recentFoodsList li, #manageSearchResults li {
             cursor: pointer; transition: background-color 0.2s ease; border-color: #e5e7eb;
        }
        .dark #searchResults, .dark #recentFoodsList, .dark #manageSearchResults {
             background-color: #374151; border-color: #4b5563;
        }
        .dark #searchResults li, .dark #recentFoodsList li, .dark #manageSearchResults li {
             border-color: #4b5563;
        }
        #searchResults li:hover, #recentFoodsList li:hover, #manageSearchResults li:hover {
             background-color: #e5e7eb;
        }
        .dark #searchResults li:hover, .dark #recentFoodsList li:hover, .dark #manageSearchResults li:hover {
             background-color: #4b5563;
        }
        #searchResults .add-new-food-option { font-style: italic; color: #4f46e5; }
        .dark #searchResults .add-new-food-option { color: #818cf8; }

        /* 檔案上傳 */
        input[type="file"] { display: none; }
        .custom-file-upload {
            border: 1px solid #6b7280; display: inline-block; padding: 6px 12px; cursor: pointer;
            background-color: #4f46e5; color: white; border-radius: 0.375rem; transition: background-color 0.2s ease;
        }
        .custom-file-upload:hover { background-color: #4338ca; }
        .dark .custom-file-upload { background-color: #6366f1; border-color: #4f46e5; }
        .dark .custom-file-upload:hover { background-color: #4f46e5; }

        /* 區塊間距 */
        .section-spacing { margin-bottom: 1.5rem; }

        /* 深色模式輸入框、下拉選單 */
        .dark input[type="number"], .dark input[type="text"], .dark input[type="date"], .dark select {
            background-color: #374151; border-color: #4b5563; color: #d1d5db;
        }
        .dark input[type="number"]:focus, .dark input[type="text"]:focus, .dark input[type="date"]:focus, .dark select:focus {
            border-color: #6366f1; --tw-ring-color: #6366f1;
        }
        .dark select option { background-color: #374151; color: #d1d5db; }
        .dark input::placeholder { color: #6b7280; }
        .dark input:read-only { background-color: #4b5563; cursor: not-allowed; }

        /* 深色模式按鈕 */
        .dark .delete-log-entry { color: #f87171; }
        .dark .delete-log-entry:hover { color: #ef4444; }
        .dark *:focus { --tw-ring-offset-color: #1f2937 !important; }

        /* 預設隱藏區塊 */
        #addFoodDataSection, #manageFoodEditSection, #recentFoodsSection { display: none; }

        /* 調整 Grid */
        #addFoodDataSection .grid, #manageFoodEditSection .grid { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        @media (min-width: 768px) { #addFoodDataSection .grid, #manageFoodEditSection .grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        @media (min-width: 1024px) { #addFoodDataSection .grid, #manageFoodEditSection .grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
        #targetSettingsGrid { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        @media (min-width: 640px) { #targetSettingsGrid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }

        /* 管理區塊按鈕 */
        .manage-btn {
            padding: 6px 12px; border-radius: 0.375rem; font-weight: bold;
            transition: background-color 0.2s ease; color: white;
        }
        .manage-btn.update { background-color: #10b981; } .manage-btn.update:hover { background-color: #059669; }
        .manage-btn.delete { background-color: #ef4444; } .manage-btn.delete:hover { background-color: #dc2626; }
        .dark .manage-btn.update { background-color: #34d399; } .dark .manage-btn.update:hover { background-color: #10b981; }
        .dark .manage-btn.delete { background-color: #f87171; } .dark .manage-btn.delete:hover { background-color: #ef4444; }

        /* 最近新增按鈕 */
        #toggleRecentFoodsBtn {
            background-color: #fbbf24; /* Amber-400 */
            color: #78350f; /* Amber-900 */
        }
        #toggleRecentFoodsBtn:hover { background-color: #f59e0b; /* Amber-500 */ }
        .dark #toggleRecentFoodsBtn {
            background-color: #fcd34d; /* Amber-300 */
            color: #92400e; /* Amber-800 */
        }
        .dark #toggleRecentFoodsBtn:hover { background-color: #fbbf24; /* Amber-400 */ }

    </style>
    <script>
        // Tailwind 深色模式設定 (可選)
        // ...
    </script>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
        <h1 class="text-2xl md:text-3xl font-bold mb-6 text-center text-gray-800 dark:text-gray-100">食物熱量計算器</h1>

        <div class="section-spacing p-4 bg-green-50 dark:bg-green-900/30 rounded-lg border border-green-200 dark:border-green-700/50">
            <h2 class="text-xl font-semibold mb-3 text-gray-700 dark:text-green-200">新增飲食紀錄</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="foodSearch" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">搜尋食物:</label>
                    <input type="text" id="foodSearch" placeholder="輸入食物名稱..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500">
                    <ul id="searchResults" class="mt-1 border rounded-md bg-white max-h-40 overflow-y-auto shadow-sm"></ul>
                </div>
                 <div>
                    <label for="foodQuantity" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">重量(克):</label>
                    <input type="number" id="foodQuantity" value="100" min="1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500">
                 </div>
                <div>
                    <label for="mealType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">餐別:</label>
                    <select id="mealType" class="w-full p-2 border border-gray-300 rounded-md bg-white focus:ring-green-500 focus:border-green-500">
                        <option value="breakfast">早餐</option>
                        <option value="lunch">午餐</option>
                        <option value="dinner">晚餐</option>
                        <option value="snack">點心/其他</option>
                    </select>
                </div>
            </div>
             <div class="mb-4">
                 <p id="selectedFoodInfo" class="text-sm text-gray-600 dark:text-gray-400 italic">請先搜尋並選擇食物</p>
             </div>
             <div class="flex flex-wrap gap-4 items-center">
                 <button id="addFoodLogBtn" class="bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                     新增紀錄
                 </button>
                 <button id="toggleRecentFoodsBtn" type="button" class="font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out">
                     顯示/隱藏最近新增
                 </button>
             </div>

             <div id="recentFoodsSection" class="mt-4 pt-4 border-t border-green-200 dark:border-green-700/50">
                 <h4 class="text-md font-semibold mb-2 text-gray-700 dark:text-green-300">最近新增的食物</h4>
                 <ul id="recentFoodsList" class="border rounded-md bg-white max-h-32 overflow-y-auto shadow-sm">
                     <li class="p-2 text-gray-500 dark:text-gray-400">尚無最近紀錄</li>
                 </ul>
             </div>

            <div id="addFoodDataSection" class="mt-6 pt-4 border-t border-green-200 dark:border-green-700/50">
                 <h3 class="text-lg font-semibold mb-3 text-gray-700 dark:text-purple-200">新增食物資料</h3>
                 <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">請輸入以下新食物的營養資訊 (皆以每 100 克計算)。</p>
                 <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4">
                     <div>
                         <label for="newFoodName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">食物名稱:</label>
                         <input type="text" id="newFoodName" placeholder="例如：烤地瓜" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                     </div>
                     <div>
                         <label for="newFoodCalories" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">熱量 (大卡):</label>
                         <input type="number" id="newFoodCalories" placeholder="例如：86" min="0" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                     </div>
                     <div>
                         <label for="newFoodCarbs" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">總碳水 (克):</label>
                         <input type="number" id="newFoodCarbs" placeholder="例如：20.1" min="0" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                     </div>
                     <div>
                         <label for="newFoodFat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">脂肪 (克):</label>
                         <input type="number" id="newFoodFat" placeholder="例如：0.1" min="0" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                     </div>
                     <div>
                         <label for="newFoodProtein" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">蛋白質 (克):</label>
                         <input type="number" id="newFoodProtein" placeholder="例如：1.6" min="0" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                     </div>
                     <div>
                         <label for="newFoodSodium" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">鈉 (毫克):</label>
                         <input type="number" id="newFoodSodium" placeholder="例如：55" min="0" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                     </div>
                      <div>
                         <label for="newFoodSugar" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">糖 (克):</label>
                         <input type="number" id="newFoodSugar" placeholder="例如：4.2" min="0" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                     </div>
                 </div>
                 <div class="flex gap-4">
                     <button id="addFoodToDbBtn" class="w-full md:w-auto bg-purple-600 hover:bg-purple-700 dark:bg-purple-500 dark:hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out">
                         儲存新食物
                     </button>
                     <button id="cancelAddFoodBtn" type="button" class="w-full md:w-auto bg-gray-500 hover:bg-gray-600 dark:bg-gray-600 dark:hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out">
                         取消
                     </button>
                 </div>
            </div>
        </div>

        <div class="section-spacing p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg border border-blue-200 dark:border-blue-700/50">
            <h2 class="text-xl font-semibold mb-3 text-gray-700 dark:text-blue-200">飲食紀錄與統計</h2>
            <div class="flex justify-between items-center mb-3">
                 <label for="recordDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">選擇日期:</label>
                 <input type="date" id="recordDate" class="p-1 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div id="dailySummary" class="mb-4 p-3 bg-white dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600">
                <h3 class="font-semibold text-gray-800 dark:text-gray-100 mb-2">當日總計</h3>
                <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm mb-3">
                    <p class="text-gray-700 dark:text-gray-300">總熱量: <span id="totalCalories" class="font-medium text-gray-900 dark:text-gray-50">0</span> 大卡</p>
                    <p class="text-gray-700 dark:text-gray-300">剩餘熱量: <span id="remainingCalories" class="font-bold text-blue-600 dark:text-blue-400">N/A</span></p>
                    <p class="text-gray-700 dark:text-gray-300">總碳水: <span id="totalCarbs" class="font-medium text-gray-900 dark:text-gray-50">0</span> 克</p>
                    <p class="text-gray-700 dark:text-gray-300">剩餘碳水: <span id="remainingCarbs" class="font-bold text-gray-600 dark:text-gray-400">N/A</span></p>
                    <p class="text-gray-700 dark:text-gray-300">總脂肪: <span id="totalFat" class="font-medium text-gray-900 dark:text-gray-50">0</span> 克</p>
                    <p class="text-gray-700 dark:text-gray-300">剩餘脂肪: <span id="remainingFat" class="font-bold text-gray-600 dark:text-gray-400">N/A</span></p>
                    <p class="text-gray-700 dark:text-gray-300">總蛋白質: <span id="totalProtein" class="font-medium text-gray-900 dark:text-gray-50">0</span> 克</p>
                    <p class="text-gray-700 dark:text-gray-300">剩餘蛋白: <span id="remainingProtein" class="font-bold text-gray-600 dark:text-gray-400">N/A</span></p>
                    <p class="text-gray-700 dark:text-gray-300">總鈉: <span id="totalSodium" class="font-medium text-gray-900 dark:text-gray-50">0</span> 毫克</p>
                    <span></span> <p class="text-gray-700 dark:text-gray-300">總糖: <span id="totalSugar" class="font-medium text-gray-900 dark:text-gray-50">0</span> 克</p>
                </div>

                 <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-600">
                     <h4 class="text-base font-medium text-gray-700 dark:text-indigo-200 mb-2">每日目標設定</h4>
                     <div id="targetSettingsGrid" class="grid gap-4">
                         <div>
                             <label for="dailyCaloriesTarget" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">目標熱量 (大卡):</label>
                             <input type="number" id="dailyCaloriesTarget" placeholder="例如：2000" min="0" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200 dark:focus:border-indigo-500 dark:focus:ring-indigo-500">
                         </div>
                         <div>
                             <label for="dailyCarbsTarget" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">目標碳水 (克):</label>
                             <input type="number" id="dailyCarbsTarget" placeholder="例如：300" min="0" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200 dark:focus:border-indigo-500 dark:focus:ring-indigo-500">
                         </div>
                         <div>
                             <label for="dailyFatTarget" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">目標脂肪 (克):</label>
                             <input type="number" id="dailyFatTarget" placeholder="例如：60" min="0" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200 dark:focus:border-indigo-500 dark:focus:ring-indigo-500">
                         </div>
                         <div>
                             <label for="dailyProteinTarget" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">目標蛋白質 (克):</label>
                             <input type="number" id="dailyProteinTarget" placeholder="例如：100" min="0" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200 dark:focus:border-indigo-500 dark:focus:ring-indigo-500">
                         </div>
                     </div>
                     <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">輸入您的每日攝取目標，將自動計算剩餘量。</p>
                 </div>
            </div>

            <div id="mealLog" class="space-y-4"></div>
        </div>

        <div class="p-4 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg border border-yellow-200 dark:border-yellow-700/50">
             <h2 class="text-xl font-semibold mb-3 text-gray-700 dark:text-yellow-200">資料管理</h2>

             <div class="mb-6 pb-4 border-b border-yellow-200 dark:border-yellow-700/50">
                 <h3 class="text-lg font-medium mb-2 text-gray-700 dark:text-yellow-300">匯出 / 匯入</h3>
                 <div class="flex flex-col md:flex-row gap-4 mb-2">
                    <button id="exportFoodDbBtn" class="bg-yellow-500 hover:bg-yellow-600 dark:bg-yellow-600 dark:hover:bg-yellow-700 text-white dark:text-yellow-100 font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out">
                        匯出食物資料庫
                    </button>
                    <button id="exportLogBtn" class="bg-yellow-500 hover:bg-yellow-600 dark:bg-yellow-600 dark:hover:bg-yellow-700 text-white dark:text-yellow-100 font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out">
                        匯出飲食紀錄
                    </button>
                    <label for="importFoodDbFile" class="custom-file-upload">
                        匯入食物資料庫
                    </label>
                    <input type="file" id="importFoodDbFile" accept=".json">
                    <label for="importLogFile" class="custom-file-upload">
                        匯入飲食紀錄
                    </label>
                    <input type="file" id="importLogFile" accept=".json">
                 </div>
                 <p class="text-sm text-gray-500 dark:text-gray-400">分別匯入食物資料庫 (僅含食物陣列) 或飲食紀錄 (含設定)。</p>
             </div>

             <div>
                 <h3 class="text-lg font-medium mb-2 text-gray-700 dark:text-yellow-300">管理食物資料庫</h3>
                 <div class="mb-4">
                     <label for="manageFoodSearch" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">搜尋食物:</label>
                     <input type="text" id="manageFoodSearch" placeholder="輸入要管理的食物名稱..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-yellow-500 focus:border-yellow-500">
                     <ul id="manageSearchResults" class="mt-1 border rounded-md bg-white max-h-40 overflow-y-auto shadow-sm">
                     </ul>
                 </div>
                 <div id="manageFoodResult" class="text-sm text-gray-600 dark:text-gray-400 mb-4 hidden">搜尋結果提示區</div>
                 <div id="manageFoodEditSection" class="mt-4 pt-4 border-t border-yellow-200 dark:border-yellow-700/50">
                     <h4 class="text-md font-semibold mb-3 text-gray-700 dark:text-purple-200">修改食物資料</h4>
                     <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4">
                         <div>
                             <label for="editFoodName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">食物名稱 (唯讀):</label>
                             <input type="text" id="editFoodName" class="w-full p-2 border border-gray-300 rounded-md" readonly>
                         </div>
                         <div>
                             <label for="editFoodCalories" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">熱量 (大卡):</label>
                             <input type="number" id="editFoodCalories" min="0" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                         </div>
                         <div>
                             <label for="editFoodCarbs" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">總碳水 (克):</label>
                             <input type="number" id="editFoodCarbs" min="0" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                         </div>
                         <div>
                             <label for="editFoodFat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">脂肪 (克):</label>
                             <input type="number" id="editFoodFat" min="0" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                         </div>
                         <div>
                             <label for="editFoodProtein" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">蛋白質 (克):</label>
                             <input type="number" id="editFoodProtein" min="0" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                         </div>
                         <div>
                             <label for="editFoodSodium" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">鈉 (毫克):</label>
                             <input type="number" id="editFoodSodium" min="0" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                         </div>
                          <div>
                             <label for="editFoodSugar" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">糖 (克):</label>
                             <input type="number" id="editFoodSugar" min="0" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                         </div>
                     </div>
                     <div class="flex gap-4">
                         <button id="updateFoodDbBtn" class="manage-btn update">
                             儲存修改
                         </button>
                         <button id="deleteFoodDbBtn" class="manage-btn delete">
                             刪除此食物
                         </button>
                         <button id="cancelEditFoodBtn" type="button" class="w-full md:w-auto bg-gray-500 hover:bg-gray-600 dark:bg-gray-600 dark:hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out">
                            取消修改
                        </button>
                     </div>
                 </div>
             </div>
        </div>
    </div>

    <div id="messageBox" class="message-box"></div>

    <script>
        // --- 預設食物資料 ---
        const defaultFoodDatabase = [ /* ... */ ];

        // --- Dexie 資料庫設定 ---
        const db = new Dexie('CalorieTrackerDB');
        db.version(1).stores({
            foods: 'name, carbs, calories, fat, protein, sodium, sugar',
            settings: 'key',
            logEntries: '++id, date, mealType'
        });

        // --- DOM 元素 ---
        // ... (所有 DOM 元素宣告) ...
        const dailyCaloriesTargetInput = document.getElementById('dailyCaloriesTarget');
        const dailyCarbsTargetInput = document.getElementById('dailyCarbsTarget');
        const dailyFatTargetInput = document.getElementById('dailyFatTarget');
        const dailyProteinTargetInput = document.getElementById('dailyProteinTarget');
        const addFoodDataSection = document.getElementById('addFoodDataSection');
        const newFoodNameInput = document.getElementById('newFoodName');
        const newFoodCaloriesInput = document.getElementById('newFoodCalories');
        const newFoodCarbsInput = document.getElementById('newFoodCarbs');
        const newFoodFatInput = document.getElementById('newFoodFat');
        const newFoodProteinInput = document.getElementById('newFoodProtein');
        const newFoodSodiumInput = document.getElementById('newFoodSodium');
        const newFoodSugarInput = document.getElementById('newFoodSugar');
        const addFoodToDbBtn = document.getElementById('addFoodToDbBtn');
        const cancelAddFoodBtn = document.getElementById('cancelAddFoodBtn');
        const foodSearchInput = document.getElementById('foodSearch');
        const searchResultsUl = document.getElementById('searchResults');
        const foodQuantityInput = document.getElementById('foodQuantity');
        const mealTypeSelect = document.getElementById('mealType');
        const addFoodLogBtn = document.getElementById('addFoodLogBtn');
        const selectedFoodInfoP = document.getElementById('selectedFoodInfo');
        const recordDateInput = document.getElementById('recordDate');
        const mealLogDiv = document.getElementById('mealLog');
        const totalCaloriesSpan = document.getElementById('totalCalories');
        const totalCarbsSpan = document.getElementById('totalCarbs');
        const totalFatSpan = document.getElementById('totalFat');
        const totalProteinSpan = document.getElementById('totalProtein');
        const totalSodiumSpan = document.getElementById('totalSodium');
        const totalSugarSpan = document.getElementById('totalSugar');
        const remainingCaloriesSpan = document.getElementById('remainingCalories');
        const remainingCarbsSpan = document.getElementById('remainingCarbs');
        const remainingFatSpan = document.getElementById('remainingFat');
        const remainingProteinSpan = document.getElementById('remainingProtein');
        const messageBox = document.getElementById('messageBox');
        const manageFoodSearchInput = document.getElementById('manageFoodSearch');
        const manageSearchResultsUl = document.getElementById('manageSearchResults');
        const manageFoodResultDiv = document.getElementById('manageFoodResult');
        const manageFoodEditSection = document.getElementById('manageFoodEditSection');
        const editFoodNameInput = document.getElementById('editFoodName');
        const editFoodCaloriesInput = document.getElementById('editFoodCalories');
        const editFoodCarbsInput = document.getElementById('editFoodCarbs');
        const editFoodFatInput = document.getElementById('editFoodFat');
        const editFoodProteinInput = document.getElementById('editFoodProtein');
        const editFoodSodiumInput = document.getElementById('editFoodSodium');
        const editFoodSugarInput = document.getElementById('editFoodSugar');
        const updateFoodDbBtn = document.getElementById('updateFoodDbBtn');
        const deleteFoodDbBtn = document.getElementById('deleteFoodDbBtn');
        const cancelEditFoodBtn = document.getElementById('cancelEditFoodBtn');
        const exportFoodDbBtn = document.getElementById('exportFoodDbBtn');
        const exportLogBtn = document.getElementById('exportLogBtn');
        const importFoodDbFileLabel = document.querySelector('label[for="importFoodDbFile"]');
        const importFoodDbFileInput = document.getElementById('importFoodDbFile');
        const importLogFileLabel = document.querySelector('label[for="importLogFile"]');
        const importLogFileInput = document.getElementById('importLogFile');
        const toggleRecentFoodsBtn = document.getElementById('toggleRecentFoodsBtn');
        const recentFoodsSection = document.getElementById('recentFoodsSection');
        const recentFoodsListUl = document.getElementById('recentFoodsList');


        // --- 狀態變數 ---
        let dailyTargetCalories = 0;
        let dailyTargetCarbs = 0;
        let dailyTargetFat = 0;
        let dailyTargetProtein = 0;
        let selectedFood = null;
        let selectedDate = '';
        let currentDayLogEntries = [];
        let foodNameToManage = null;
        const MAX_RECENT_FOODS = 10;
        let manageSearchDebounceTimer;

        // --- 初始化 ---
        async function initialize() {
            const today = new Date().toISOString().split('T')[0];
            recordDateInput.value = today;
            selectedDate = today;

            try {
                await db.open();
                await initializeFoodDatabase();
                await loadUserSettings();
                await loadAndRenderDayLog(selectedDate);
                renderRecentFoodsList();
            } catch (error) {
                 console.error("資料庫初始化失敗:", error);
                 showMessage("應用程式初始化失敗。", "error");
            }

            // 事件監聽器
            dailyCaloriesTargetInput.addEventListener('change', handleDailyTargetChange);
            dailyCarbsTargetInput.addEventListener('change', handleDailyTargetChange);
            dailyFatTargetInput.addEventListener('change', handleDailyTargetChange);
            dailyProteinTargetInput.addEventListener('change', handleDailyTargetChange);
            addFoodToDbBtn.addEventListener('click', handleAddFoodToDatabase);
            cancelAddFoodBtn.addEventListener('click', hideAddFoodSection);
            searchResultsUl.addEventListener('click', handleSearchResultClick);
            foodSearchInput.addEventListener('input', handleFoodSearch);
            foodSearchInput.addEventListener('blur', () => setTimeout(() => {
                 if (!searchResultsUl.querySelector('.add-new-food-option') || searchResultsUl.children.length > 1) {
                      searchResultsUl.innerHTML = '';
                 }
            }, 200));
            addFoodLogBtn.addEventListener('click', handleAddFoodLog); // 確認事件綁定
            recordDateInput.addEventListener('change', handleDateChange);
            // 資料管理相關 (使用 debounce)
            manageFoodSearchInput.addEventListener('input', handleManageFoodSearchInput); // 改為觸發 debounce 的函式
            manageSearchResultsUl.addEventListener('click', handleManageResultClick);
            updateFoodDbBtn.addEventListener('click', handleUpdateFoodDb);
            deleteFoodDbBtn.addEventListener('click', handleDeleteFoodDb);
            cancelEditFoodBtn.addEventListener('click', hideManageFoodEditSection);
            // 匯出/匯入
            exportFoodDbBtn.addEventListener('click', handleExportFoodDb);
            exportLogBtn.addEventListener('click', handleExportLog);
            importFoodDbFileInput.addEventListener('change', (e) => handleImportData(e, 'foodsOnly'));
            importLogFileInput.addEventListener('change', (e) => handleImportData(e, 'logsOnly'));
            // 飲食紀錄與最近新增
            mealLogDiv.addEventListener('click', handleDeleteLogEntry);
            toggleRecentFoodsBtn.addEventListener('click', toggleRecentFoodsSection);
            recentFoodsListUl.addEventListener('click', handleRecentFoodClick);
        }

        // --- Debounce 輔助函式 ---
        function debounce(func, delay) {
          let timeoutId;
          return function(...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
              func.apply(this, args);
            }, delay);
          };
        }


        // --- 資料庫初始化與載入 ---
        async function initializeFoodDatabase() { /* ... */ }
        async function loadUserSettings() { /* ... */ }
        async function loadAndRenderDayLog(date) { /* ... */ }

        // --- 顯示/隱藏 區塊 ---
        function showAddFoodSection(searchQuery = '') { /* ... */ }
        function hideAddFoodSection() { /* ... */ }
        function showManageFoodEditSection(food) { /* ... */ }
        function hideManageFoodEditSection() { /* ... */ }
        function toggleRecentFoodsSection() { /* ... */ }

        // --- 最近新增食物處理 (修改) ---
        function getRecentFoods() { /* ... */ }
        function addRecentFood(foodName, quantity) { /* ... */ } // 已修改
        function renderRecentFoodsList() { /* ... */ } // 已修改
        async function handleRecentFoodClick(event) { /* ... */ } // 已修改

        // --- 事件處理函式 ---
        async function handleDailyTargetChange(event) { /* ... */ }
        async function handleAddFoodToDatabase() { /* ... */ }
        async function handleFoodSearch() { /* ... */ }
        function handleSearchResultClick(event) { /* ... */ }
        function selectFood(food) { /* ... */ }
        async function handleAddFoodLog() { /* ... */ } // 已修改處理缺失營養素 & 最近新增
        async function handleDateChange() { /* ... */ }
        async function handleDeleteLogEntry(event) { /* ... */ }

        // --- 食物資料庫管理函式 (修改搜尋方式) ---
        async function performManageFoodSearch() { /* ... */ } // 實際搜尋邏輯
        // *** 移除重複宣告 ***
        // const debouncedManageFoodSearch = debounce(performManageFoodSearch, 300);
        function handleManageFoodSearchInput() { debouncedManageFoodSearch(); } // 觸發 debounce
        function handleManageResultClick(event) { /* ... */ }
        async function handleUpdateFoodDb() { /* ... */ }
        async function handleDeleteFoodDb() { /* ... */ }

        // --- 匯出/匯入函式 ---
        function triggerDownload(data, filename) { /* ... */ }
        async function handleExportFoodDb() { /* ... */ }
        async function handleExportLog() { /* ... */ }
        async function handleImportData(event, importMode) { /* ... */ } // 已修改處理兩種食物格式

        // --- 畫面更新 ---
        function updateDailySummary() { /* ... (已修改) ... */ }
        function renderMealLog() { /* ... (已修改) ... */ }

        // --- 工具函式 ---
        function getMealTypeName(mealType) { /* ... */ }
        // getUnitFromName 已移除
        let messageTimeout;
        function showMessage(text, type = 'success') { /* ... */ }

        // --- 複製貼上未變更的函式 ---
        async function initializeFoodDatabase() {
            const count = await db.foods.count();
            if (count === 0) {
                console.log("IndexedDB 'foods' 表為空，嘗試初始化...");
                try {
                    console.log("嘗試從 ./data/food_database.json 讀取...");
                    const response = await fetch('./data/food_database.json');
                    if (!response.ok) {
                         console.warn("無法讀取 ./data/food_database.json，將使用預設資料。");
                         throw new Error('File fetch failed');
                    }
                    const fileData = await response.json();
                    console.log("成功讀取 ./data/food_database.json");
                    let foodArray = [];
                    if (Array.isArray(fileData)) {
                        console.log("檔案格式為食物陣列，直接使用。");
                        foodArray = fileData;
                    } else if (fileData && Array.isArray(fileData.foods)) {
                        console.log("檔案格式為完整匯出檔，提取 'foods' 陣列。");
                        foodArray = fileData.foods;
                    } else {
                         console.warn("無法識別 ./data/food_database.json 的格式，將使用預設資料。");
                         throw new Error('Invalid JSON structure');
                    }
                    const foodsToLoad = foodArray.map(food => ({ ...food, carbs: food.carbs ?? 0 }));
                    await db.foods.bulkPut(foodsToLoad);
                    console.log("成功從 ./data/food_database.json 初始化食物資料庫");
                    showMessage("食物資料庫已從檔案載入", "info");
                } catch (error) {
                    console.warn("初始化食物資料庫失敗，使用預設資料:", error);
                    const defaultDataWithCarbs = defaultFoodDatabase.map(food => ({ ...food, carbs: food.carbs ?? 0 }));
                    await db.foods.bulkPut(defaultDataWithCarbs);
                    showMessage("讀取檔案失敗或格式錯誤，使用預設食物資料庫", "error");
                }
            } else {
                 console.log("IndexedDB 'foods' 表已存在資料。");
            }
        }
        async function loadUserSettings() {
            try {
                const settings = await db.settings.bulkGet([
                    'dailyTargetCalories', 'dailyTargetCarbs', 'dailyTargetFat', 'dailyTargetProtein'
                ]);
                const calorieSetting = settings[0]; const carbSetting = settings[1];
                const fatSetting = settings[2]; const proteinSetting = settings[3];
                dailyTargetCalories = calorieSetting ? (parseInt(calorieSetting.value, 10) || 0) : 0;
                dailyTargetCarbs = carbSetting ? (parseInt(carbSetting.value, 10) || 0) : 0;
                dailyTargetFat = fatSetting ? (parseInt(fatSetting.value, 10) || 0) : 0;
                dailyTargetProtein = proteinSetting ? (parseInt(proteinSetting.value, 10) || 0) : 0;
                dailyCaloriesTargetInput.value = dailyTargetCalories > 0 ? dailyTargetCalories : '';
                dailyCarbsTargetInput.value = dailyTargetCarbs > 0 ? dailyTargetCarbs : '';
                dailyFatTargetInput.value = dailyTargetFat > 0 ? dailyTargetFat : '';
                dailyProteinTargetInput.value = dailyTargetProtein > 0 ? dailyTargetProtein : '';
                console.log("每日目標已載入:", { calories: dailyTargetCalories, carbs: dailyTargetCarbs, fat: dailyTargetFat, protein: dailyTargetProtein });
            } catch (error) {
                 console.error("載入使用者設定失敗:", error); showMessage("載入設定失敗", "error");
            }
        }
        async function loadAndRenderDayLog(date) {
            try {
                currentDayLogEntries = await db.logEntries.where('date').equals(date).toArray();
                console.log(`載入日期 ${date} 的紀錄:`, currentDayLogEntries);
                updateDailySummary(); renderMealLog();
            } catch (error) {
                console.error(`載入日期 ${date} 的紀錄失敗:`, error); showMessage("載入飲食紀錄失敗", "error");
                currentDayLogEntries = []; updateDailySummary(); renderMealLog();
            }
        }
        function showAddFoodSection(searchQuery = '') {
            newFoodNameInput.value = searchQuery;
            [newFoodCaloriesInput, newFoodCarbsInput, newFoodFatInput, newFoodProteinInput, newFoodSodiumInput, newFoodSugarInput].forEach(input => input.value = '');
            addFoodDataSection.style.display = 'block'; newFoodCaloriesInput.focus(); searchResultsUl.innerHTML = '';
        }
        function hideAddFoodSection() {
            addFoodDataSection.style.display = 'none';
            [newFoodNameInput, newFoodCaloriesInput, newFoodCarbsInput, newFoodFatInput, newFoodProteinInput, newFoodSodiumInput, newFoodSugarInput].forEach(input => input.value = '');
        }
         function showManageFoodEditSection(food) {
            if (!food) return;
            foodNameToManage = food.name; editFoodNameInput.value = food.name;
            editFoodCaloriesInput.value = food.calories ?? ''; editFoodCarbsInput.value = food.carbs ?? '';
            editFoodFatInput.value = food.fat ?? ''; editFoodProteinInput.value = food.protein ?? '';
            editFoodSodiumInput.value = food.sodium ?? ''; editFoodSugarInput.value = food.sugar ?? '';
            manageFoodEditSection.style.display = 'block'; manageFoodResultDiv.textContent = `正在編輯：${food.name}`;
        }
        function hideManageFoodEditSection() {
            manageFoodEditSection.style.display = 'none'; foodNameToManage = null;
            manageFoodResultDiv.textContent = '請輸入食物名稱並按搜尋。'; manageFoodSearchInput.value = ''; manageSearchResultsUl.innerHTML = '';
        }
         function toggleRecentFoodsSection() {
            const isHidden = recentFoodsSection.style.display === 'none' || recentFoodsSection.style.display === '';
            recentFoodsSection.style.display = isHidden ? 'block' : 'none';
            if (isHidden) { renderRecentFoodsList(); }
        }
        function getRecentFoods() {
            const recent = localStorage.getItem('recentFoods');
            try { return recent ? JSON.parse(recent) : []; }
            catch (e) { console.error("解析最近食物列表失敗:", e); localStorage.removeItem('recentFoods'); return []; }
        }
        function addRecentFood(foodName, quantity) {
            let recent = getRecentFoods(); recent = recent.filter(item => item.name !== foodName);
            recent.unshift({ name: foodName, quantity: quantity });
            if (recent.length > MAX_RECENT_FOODS) { recent = recent.slice(0, MAX_RECENT_FOODS); }
            localStorage.setItem('recentFoods', JSON.stringify(recent));
            if (recentFoodsSection.style.display === 'block') { renderRecentFoodsList(); }
        }
        function renderRecentFoodsList() {
            const recent = getRecentFoods(); recentFoodsListUl.innerHTML = '';
            if (recent.length === 0) { recentFoodsListUl.innerHTML = '<li class="p-2 text-gray-500 dark:text-gray-400">尚無最近紀錄</li>'; }
            else { recent.forEach(item => { const li = document.createElement('li'); li.textContent = item.name; li.className = 'p-2 border-b last:border-b-0 dark:text-gray-200 recent-food-item'; li.dataset.name = item.name; li.dataset.quantity = item.quantity; recentFoodsListUl.appendChild(li); }); }
        }
        async function handleRecentFoodClick(event) {
            const targetLi = event.target.closest('li.recent-food-item'); if (!targetLi) return;
            const foodName = targetLi.dataset.name; const lastQuantity = targetLi.dataset.quantity;
            if (foodName) {
                console.log("選擇最近新增:", foodName, "上次數量:", lastQuantity); foodSearchInput.value = foodName; searchResultsUl.innerHTML = '';
                if (lastQuantity && !isNaN(parseFloat(lastQuantity))) { foodQuantityInput.value = parseFloat(lastQuantity); } else { foodQuantityInput.value = 100; }
                try { const food = await db.foods.get(foodName); if (food) { selectFood(food); } else { showMessage(`在資料庫中找不到最近紀錄的食物 "${foodName}"，可能已被刪除。`, "error"); } }
                catch(error) { console.error("查找最近食物時出錯:", error); showMessage("選擇最近食物時發生錯誤", "error"); }
            }
        }
        async function handleDailyTargetChange(event) {
            const inputId = event.target.id; const value = parseInt(event.target.value, 10) || 0;
            let targetKey = ''; let targetName = '';
            switch (inputId) {
                case 'dailyCaloriesTarget': dailyTargetCalories = value; targetKey = 'dailyTargetCalories'; targetName = '熱量'; break;
                case 'dailyCarbsTarget': dailyTargetCarbs = value; targetKey = 'dailyTargetCarbs'; targetName = '碳水化合物'; break;
                case 'dailyFatTarget': dailyTargetFat = value; targetKey = 'dailyTargetFat'; targetName = '脂肪'; break;
                case 'dailyProteinTarget': dailyTargetProtein = value; targetKey = 'dailyTargetProtein'; targetName = '蛋白質'; break;
                default: return;
            }
            try { await db.settings.put({ key: targetKey, value: value }); updateDailySummary(); showMessage(`每日目標${targetName}已更新`, "success"); console.log(`每日目標 ${targetKey} 已儲存:`, value); }
            catch (error) { console.error(`儲存每日目標 ${targetKey} 失敗:`, error); showMessage("儲存設定失敗", "error"); }
        }
        async function handleAddFoodToDatabase() {
            const name = newFoodNameInput.value.trim(); const calories = parseFloat(newFoodCaloriesInput.value); const carbs = parseFloat(newFoodCarbsInput.value); const fat = parseFloat(newFoodFatInput.value); const protein = parseFloat(newFoodProteinInput.value); const sodium = parseFloat(newFoodSodiumInput.value); const sugar = parseFloat(newFoodSugarInput.value);
            if (!name || isNaN(calories) || isNaN(carbs) || isNaN(fat) || isNaN(protein) || isNaN(sodium) || isNaN(sugar) || calories < 0 || carbs < 0 || fat < 0 || protein < 0 || sodium < 0 || sugar < 0) { showMessage("請輸入有效的食物名稱與非負數的營養數值", "error"); return; }
            const newFood = { name, calories, carbs, fat, protein, sodium, sugar };
            try { await db.foods.add(newFood); hideAddFoodSection(); showMessage(`"${name}" 已成功新增至食物資料庫!`, "success"); }
            catch (error) { if (error.name === 'ConstraintError') { showMessage(`"${name}" 已存在於資料庫中。`, "error"); } else { console.error("新增食物至資料庫失敗:", error); showMessage("新增食物失敗", "error"); } }
        }
        async function handleFoodSearch() {
            const query = foodSearchInput.value.trim(); const lowerCaseQuery = query.toLowerCase(); searchResultsUl.innerHTML = ''; selectedFood = null; addFoodLogBtn.disabled = true; selectedFoodInfoP.textContent = '請先搜尋並選擇食物'; selectedFoodInfoP.classList.add('italic'); hideAddFoodSection(); if (query.length < 1) return;
            try { const results = await db.foods.where('name').startsWithIgnoreCase(lowerCaseQuery).limit(5).toArray(); results.forEach(food => { const li = document.createElement('li'); li.textContent = food.name; li.className = 'p-2 border-b last:border-b-0 dark:text-gray-200 food-item'; li.dataset.food = JSON.stringify(food); searchResultsUl.appendChild(li); }); const addNewLi = document.createElement('li'); addNewLi.innerHTML = `找不到食物？點此新增：<span class="font-semibold">${query}</span>`; addNewLi.className = 'p-2 border-b last:border-b-0 dark:text-gray-200 add-new-food-option'; addNewLi.dataset.query = query; searchResultsUl.appendChild(addNewLi); }
            catch (error) { console.error("搜尋食物失敗:", error); showMessage("搜尋食物時發生錯誤", "error"); }
        }
        function handleSearchResultClick(event) {
            const targetLi = event.target.closest('li'); if (!targetLi) return;
            if (targetLi.classList.contains('food-item')) { try { const foodData = JSON.parse(targetLi.dataset.food); selectFood(foodData); } catch (e) { console.error("解析食物資料失敗:", e); showMessage("選擇食物時發生錯誤", "error"); } }
            else if (targetLi.classList.contains('add-new-food-option')) { const searchQuery = targetLi.dataset.query; showAddFoodSection(searchQuery); }
        }
        function selectFood(food) {
            console.log("[DEBUG] selectFood called with:", food);
            selectedFood = food; foodSearchInput.value = food.name; searchResultsUl.innerHTML = ''; addFoodLogBtn.disabled = false;
            console.log("[DEBUG] addFoodLogBtn disabled state after select:", addFoodLogBtn.disabled);
            const n = selectedFood;
            selectedFoodInfoP.textContent = `選擇: ${n.name} (每100克: ${n.calories ?? 0}大卡, 碳水:${n.carbs ?? 0}g, 脂:${n.fat ?? 0}g, 蛋:${n.protein ?? 0}g, 鈉:${n.sodium ?? 0}mg, 糖:${n.sugar ?? 0}g)`;
            selectedFoodInfoP.classList.remove('italic'); foodQuantityInput.focus(); hideAddFoodSection();
        }
        async function handleAddFoodLog() {
            console.log("[DEBUG] handleAddFoodLog called. selectedFood:", selectedFood);
            if (!selectedFood) { console.error("handleAddFoodLog: selectedFood is null or undefined."); showMessage("請先搜尋並選擇一個食物", "error"); return; }
            const quantity = parseFloat(foodQuantityInput.value); console.log("[DEBUG] handleAddFoodLog: quantity:", quantity);
            if (isNaN(quantity) || quantity <= 0) { console.error("handleAddFoodLog: Invalid quantity."); showMessage("請輸入有效的份量/重量", "error"); return; }
            const mealType = mealTypeSelect.value; const baseNutrients = selectedFood; const factor = quantity / 100;
            const calculatedNutrients = {
                calories: parseFloat(((baseNutrients.calories ?? 0) * factor).toFixed(1)), carbs: parseFloat(((baseNutrients.carbs ?? 0) * factor).toFixed(1)),
                fat: parseFloat(((baseNutrients.fat ?? 0) * factor).toFixed(1)), protein: parseFloat(((baseNutrients.protein ?? 0) * factor).toFixed(1)),
                sodium: parseFloat(((baseNutrients.sodium ?? 0) * factor).toFixed(1)), sugar: parseFloat(((baseNutrients.sugar ?? 0) * factor).toFixed(1))
            };
            for (const key in calculatedNutrients) { if (isNaN(calculatedNutrients[key])) { console.warn(`[DEBUG] Nutrient calculation resulted in NaN for ${key}. Defaulting to 0.`); calculatedNutrients[key] = 0; } }
            const logEntryData = { name: baseNutrients.name, quantity: quantity, nutrients: calculatedNutrients };
            const entryToSave = { date: selectedDate, mealType: mealType, logData: logEntryData }; console.log("[DEBUG] handleAddFoodLog: entryToSave:", entryToSave);
            try { console.log("[DEBUG] handleAddFoodLog: Attempting to add to logEntries..."); await db.logEntries.add(entryToSave); console.log("[DEBUG] handleAddFoodLog: Added successfully. Adding to recent foods..."); addRecentFood(logEntryData.name, logEntryData.quantity); console.log("[DEBUG] handleAddFoodLog: Reloading day log..."); await loadAndRenderDayLog(selectedDate); console.log("[DEBUG] handleAddFoodLog: Resetting fields..."); foodSearchInput.value = ''; selectedFood = null; addFoodLogBtn.disabled = true; selectedFoodInfoP.textContent = '請先搜尋並選擇食物'; selectedFoodInfoP.classList.add('italic'); foodQuantityInput.value = 100; showMessage(`${logEntryData.name} 已新增至 ${getMealTypeName(mealType)}`, "success"); console.log("[DEBUG] handleAddFoodLog: Completed successfully."); }
            catch (error) { console.error("新增飲食紀錄失敗 (handleAddFoodLog catch):", error); showMessage("新增紀錄失敗", "error"); }
        }
        async function handleDateChange() { selectedDate = recordDateInput.value; await loadAndRenderDayLog(selectedDate); }
        async function handleDeleteLogEntry(event) {
            const deleteButton = event.target.closest('.delete-log-entry'); if (!deleteButton) return; const entryId = parseInt(deleteButton.dataset.id, 10); if (isNaN(entryId)) return;
            try { await db.logEntries.delete(entryId); await loadAndRenderDayLog(selectedDate); showMessage("紀錄已刪除", "success"); }
            catch (error) { console.error("刪除紀錄失敗:", error); showMessage("刪除紀錄時發生錯誤", "error"); }
        }
        async function handleManageFoodSearchInput() { debouncedManageFoodSearch(); } // 改為觸發 debounce
        async function performManageFoodSearch() {
            const searchTerm = manageFoodSearchInput.value.trim().toLowerCase(); manageSearchResultsUl.innerHTML = ''; hideManageFoodEditSection(); if (searchTerm.length < 1) { manageFoodResultDiv.classList.add('hidden'); return; }
            manageFoodResultDiv.classList.remove('hidden'); manageFoodResultDiv.textContent = '搜尋中...';
            try { const results = await db.foods.where('name').startsWithIgnoreCase(searchTerm).limit(10).toArray(); if (results.length > 0) { manageFoodResultDiv.classList.add('hidden'); results.forEach(food => { const li = document.createElement('li'); li.textContent = food.name; li.className = 'p-2 border-b last:border-b-0 dark:text-gray-200 manage-food-item'; li.dataset.food = JSON.stringify(food); manageSearchResultsUl.appendChild(li); }); } else { manageFoodResultDiv.textContent = `找不到名稱開頭為 "${searchTerm}" 的食物`; } }
            catch (error) { console.error("管理搜尋食物時發生錯誤:", error); showMessage("搜尋食物資料庫時發生錯誤", "error"); manageFoodResultDiv.textContent = '搜尋時發生錯誤。'; }
        }
        // *** 確保只有一次宣告 ***
        const debouncedManageFoodSearch = debounce(performManageFoodSearch, 300);
         function handleManageResultClick(event) {
            const targetLi = event.target.closest('li.manage-food-item'); if (!targetLi) return;
            try { const foodData = JSON.parse(targetLi.dataset.food); showManageFoodEditSection(foodData); manageSearchResultsUl.innerHTML = ''; manageFoodResultDiv.classList.add('hidden'); }
            catch (e) { console.error("解析管理食物資料失敗:", e); showMessage("選擇要管理的食物時發生錯誤", "error"); }
        }
        async function handleUpdateFoodDb() {
            if (!foodNameToManage) { showMessage("沒有指定要修改的食物", "error"); return; }
            const updatedData = { calories: parseFloat(editFoodCaloriesInput.value), carbs: parseFloat(editFoodCarbsInput.value), fat: parseFloat(editFoodFatInput.value), protein: parseFloat(editFoodProteinInput.value), sodium: parseFloat(editFoodSodiumInput.value), sugar: parseFloat(editFoodSugarInput.value) };
            if (Object.values(updatedData).some(val => isNaN(val) || val < 0)) { showMessage("請輸入有效的非負數營養數值", "error"); return; }
            console.log(`準備更新食物: ${foodNameToManage}`, updatedData);
            try { const updateCount = await db.foods.update(foodNameToManage, updatedData); if (updateCount > 0) { console.log("食物更新成功"); showMessage(`食物「${foodNameToManage}」已更新`, "success"); hideManageFoodEditSection(); } else { console.warn("更新食物失敗，可能食物已被刪除"); showMessage("更新失敗，找不到該食物", "error"); hideManageFoodEditSection(); } }
            catch (error) { console.error("更新食物時發生錯誤:", error); showMessage(`更新食物時發生錯誤: ${error.message}`, "error"); }
        }
        async function handleDeleteFoodDb() {
            if (!foodNameToManage) { showMessage("沒有指定要刪除的食物", "error"); return; }
            if (!confirm(`確定要從資料庫刪除食物「${foodNameToManage}」嗎？此操作無法復原。`)) { return; }
            console.log(`準備刪除食物: ${foodNameToManage}`);
            try { await db.foods.delete(foodNameToManage); console.log("食物刪除成功"); showMessage(`食物「${foodNameToManage}」已刪除`, "success"); hideManageFoodEditSection(); }
            catch (error) { console.error("刪除食物時發生錯誤:", error); showMessage(`刪除食物時發生錯誤: ${error.message}`, "error"); }
        }
         function triggerDownload(data, filename) {
            try { const dataStr = JSON.stringify(data, null, 2); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = filename; console.log("準備觸發下載:", filename); document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); console.log("下載連結已觸發並清理。"); return true; }
            catch (error) { console.error(`觸發下載 ${filename} 失敗:`, error); return false; }
        }
        async function handleExportFoodDb() {
            console.log("開始匯出食物資料庫...");
            try { const foods = await db.foods.toArray(); console.log(`讀取到 ${foods.length} 筆食物資料`); if (foods.length === 0) { showMessage("食物資料庫目前沒有資料可匯出", "info"); console.log("沒有食物資料可匯出。"); return; } const filename = `food_database.json`; if (triggerDownload(foods, filename)) { showMessage("食物資料庫已匯出", "success"); } else { showMessage("匯出食物資料庫失敗", "error"); } }
            catch (error) { console.error("匯出食物資料庫失敗:", error); showMessage(`匯出食物資料庫時發生錯誤: ${error.message}`, "error"); }
        }
        async function handleExportLog() {
             console.log("開始匯出飲食紀錄與設定...");
            try { const settings = await db.settings.toArray(); const logEntries = await db.logEntries.toArray(); console.log(`讀取到 ${settings.length} 筆設定, ${logEntries.length} 筆紀錄`); const dataToExport = { settings, logEntries }; if (settings.length === 0 && logEntries.length === 0) { showMessage("沒有飲食紀錄或設定可匯出", "info"); console.log("沒有紀錄或設定可匯出。"); return; } const now = new Date(); const month = (now.getMonth() + 1).toString().padStart(2, '0'); const day = now.getDate().toString().padStart(2, '0'); const hour = now.getHours().toString().padStart(2, '0'); const minute = now.getMinutes().toString().padStart(2, '0'); const filename = `Rice_foodrecord_${month}${day}${hour}${minute}.json`; if (triggerDownload(dataToExport, filename)) { showMessage("飲食紀錄與設定已匯出", "success"); } else { showMessage("匯出飲食紀錄與設定失敗", "error"); } }
            catch (error) { console.error("匯出飲食紀錄與設定失敗:", error); showMessage(`匯出飲食紀錄與設定時發生錯誤: ${error.message}`, "error"); }
        }
        async function handleImportData(event, importMode) { // importMode: 'foodsOnly' or 'logsOnly'
            const file = event.target.files[0]; if (!file) return; console.log(`準備匯入檔案: ${file.name}, 模式: ${importMode}`);
            const reader = new FileReader();
            reader.onload = async function(e) {
                console.log("檔案讀取完成，開始解析 JSON...");
                try { const importedJson = JSON.parse(e.target.result); console.log("JSON 解析成功"); if (typeof importedJson !== 'object' || importedJson === null) { throw new Error("檔案內容不是有效的 JSON 物件"); }
                    let foodsToImport = []; let settingsToImport = []; let logsToImport = []; let validDataFound = false;
                    if (importMode === 'foodsOnly') { if (Array.isArray(importedJson)) { console.log("偵測到檔案格式為：僅食物陣列"); foodsToImport = importedJson.map(food => ({ ...food, carbs: food.carbs ?? 0 })); if (foodsToImport.length > 0) validDataFound = true; else throw new Error("食物資料庫檔案中未找到食物資料。"); } else if (importedJson && Array.isArray(importedJson.foods)) { console.log("偵測到檔案格式為：包含 'foods' 鍵的物件"); foodsToImport = importedJson.foods.map(food => ({ ...food, carbs: food.carbs ?? 0 })); if (foodsToImport.length > 0) validDataFound = true; else throw new Error("檔案 'foods' 陣列為空。"); } else { throw new Error("匯入的食物資料庫檔案格式應為 JSON 陣列或包含 'foods' 鍵的物件。"); } }
                    else if (importMode === 'logsOnly') { if (importedJson.settings && Array.isArray(importedJson.settings)) { settingsToImport = importedJson.settings; validDataFound = true; } if (importedJson.logEntries && Array.isArray(importedJson.logEntries)) { logsToImport = importedJson.logEntries.map(log => { if (log.logData && log.logData.nutrients && typeof log.logData.nutrients.carbs === 'undefined') { log.logData.nutrients.carbs = 0; } return log; }); validDataFound = true; } if (!validDataFound) throw new Error("飲食紀錄檔案中未找到 'settings' 或 'logEntries' 資料。"); }
                    else { throw new Error("未知的匯入模式。"); }
                    console.log("準備寫入資料庫...");
                    await db.transaction('rw', db.foods, db.settings, db.logEntries, async () => {
                        if (importMode === 'foodsOnly') { console.log("清空食物資料庫..."); await db.foods.clear(); await db.foods.bulkPut(foodsToImport); console.log(`已匯入 ${foodsToImport.length} 筆食物資料`); }
                        else if (importMode === 'logsOnly') { console.log("清空設定與紀錄資料庫..."); await db.settings.clear(); await db.logEntries.clear(); if (settingsToImport.length > 0) { await db.settings.bulkPut(settingsToImport); console.log(`已匯入 ${settingsToImport.length} 筆設定`); } if (logsToImport.length > 0) { await db.logEntries.bulkPut(logsToImport); console.log(`已匯入 ${logsToImport.length} 筆飲食紀錄`); } }
                    });
                    console.log("資料庫寫入完成。"); await loadUserSettings(); await loadAndRenderDayLog(selectedDate); showMessage("資料已成功匯入", "success");
                } catch (error) { console.error("匯入失敗:", error); showMessage(`匯入失敗: ${error.message}`, "error"); }
                finally { event.target.value = ''; console.log("匯入流程結束。"); }
            };
            reader.onerror = function(e) { console.error("讀取檔案時發生錯誤:", e); showMessage("讀取檔案時發生錯誤", "error"); event.target.value = ''; }; reader.readAsText(file);
        }
        function updateDailySummary() {
            let totals = { calories: 0, carbs: 0, fat: 0, protein: 0, sodium: 0, sugar: 0 };
            currentDayLogEntries.forEach(log => { if (log.logData && log.logData.nutrients) { const n = log.logData.nutrients; totals.calories += n.calories || 0; totals.carbs += n.carbs || 0; totals.fat += n.fat || 0; totals.protein += n.protein || 0; totals.sodium += n.sodium || 0; totals.sugar += n.sugar || 0; } });
            totalCaloriesSpan.textContent = totals.calories.toFixed(1); totalCarbsSpan.textContent = totals.carbs.toFixed(1); totalFatSpan.textContent = totals.fat.toFixed(1); totalProteinSpan.textContent = totals.protein.toFixed(1); totalSodiumSpan.textContent = totals.sodium.toFixed(1); totalSugarSpan.textContent = totals.sugar.toFixed(1);
            const updateRemaining = (target, total, spanElement) => { if (target > 0) { const remaining = target - total; spanElement.textContent = remaining.toFixed(1); spanElement.className = `font-bold ${remaining < 0 ? 'text-red-500 dark:text-red-400' : 'text-gray-600 dark:text-gray-400'}`; } else { spanElement.textContent = "N/A"; spanElement.className = 'font-bold text-gray-500 dark:text-gray-400'; } };
            updateRemaining(dailyTargetCalories, totals.calories, remainingCaloriesSpan); updateRemaining(dailyTargetCarbs, totals.carbs, remainingCarbsSpan); updateRemaining(dailyTargetFat, totals.fat, remainingFatSpan); updateRemaining(dailyTargetProtein, totals.protein, remainingProteinSpan);
            console.log("每日摘要已更新:", totals);
        }
        function renderMealLog() {
            mealLogDiv.innerHTML = ''; if (!currentDayLogEntries || currentDayLogEntries.length === 0) { mealLogDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">當日尚無紀錄</p>'; return; }
            const groupedLogs = currentDayLogEntries.reduce((acc, log) => { const meal = log.mealType || 'snack'; if (!acc[meal]) acc[meal] = []; acc[meal].push(log); return acc; }, {});
            const mealOrder = ['breakfast', 'lunch', 'dinner', 'snack']; const mealNames = { breakfast: '早餐', lunch: '午餐', dinner: '晚餐', snack: '點心/其他' };
            mealOrder.forEach(mealType => { const entries = groupedLogs[mealType]; if (entries && entries.length > 0) { const mealSection = document.createElement('div'); mealSection.className = 'mb-4 p-3 bg-white dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600'; const mealTitle = document.createElement('h4'); mealTitle.textContent = mealNames[mealType]; mealTitle.className = 'font-semibold text-lg mb-2 text-gray-700 dark:text-gray-200'; mealSection.appendChild(mealTitle); const ul = document.createElement('ul'); ul.className = 'space-y-2'; entries.forEach(log => { const entry = log.logData; if (!entry || !entry.nutrients) return; const li = document.createElement('li'); li.className = 'flex justify-between items-start text-sm border-b pb-1 last:border-b-0 border-gray-200 dark:border-gray-600'; li.innerHTML = ` <div class="text-gray-800 dark:text-gray-200"> <span class="font-medium">${entry.name || '未知食物'}</span> (${entry.quantity || '?'} 克) <br> <span class="text-xs text-gray-600 dark:text-gray-400"> 熱量: ${(entry.nutrients.calories || 0).toFixed(1)} 大卡, 碳水: ${(entry.nutrients.carbs || 0).toFixed(1)}g, 脂: ${(entry.nutrients.fat || 0).toFixed(1)}g, 蛋: ${(entry.nutrients.protein || 0).toFixed(1)}g, 鈉: ${(entry.nutrients.sodium || 0).toFixed(1)}mg, 糖: ${(entry.nutrients.sugar || 0).toFixed(1)}g </span> </div> <button class="delete-log-entry ml-2 p-1" data-id="${log.id}" aria-label="刪除此紀錄"> <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /> </svg> </button> `; ul.appendChild(li); }); mealSection.appendChild(ul); mealLogDiv.appendChild(mealSection); } });
            console.log("餐點紀錄已渲染:", selectedDate);
        }
        function getMealTypeName(mealType) { const names = { breakfast: '早餐', lunch: '午餐', dinner: '晚餐', snack: '點心/其他' }; return names[mealType] || '未知餐別'; }
        function showMessage(text, type = 'success') { messageBox.textContent = text; messageBox.classList.remove('success', 'error', 'info'); messageBox.classList.add(type, 'show'); clearTimeout(messageTimeout); messageTimeout = setTimeout(() => { messageBox.classList.remove('show'); }, 3000); }

        // --- 啟動應用程式 ---
        initialize();
    </script>
</body>
</html>
